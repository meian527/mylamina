#! /bin/bash

# set -x # debug
sdk="../SDKs/iphoneos18.0.sdk/iPhoneOS18.0.sdk"
architecture=$(dpkg --print-architecture 2>/dev/null)
objdir="ios-obj-log"

cc="$(which cc)"
cxx="$(which c++)"
CC="$cc"
CXX="$cxx"

ens() {
    if [ "$architecture" = "iphoneos-arm" ]; then
        return 0
    else
        if [ "$architecture" = "iphoneos-"* ]; then
            ldid -Sens/entitlements.plist -M -Hsha256 build/bin/lm.app/lm
            ldid -Sens/entitlements.plist -M -Hsha256 build/bin/*.app/*
            ldid -Sens/entitlements.plist -M -Hsha256 build/lib/lib*.dylib
        else
            return 0
        fi
    fi
}

main() {
    rm -rf build && mkdir build && cd build
    printf "\n#====================== CMake config ======================#\n" >> "../$objdir/build.log"
    cmake .. \
      -DCMAKE_SYSTEM_NAME=iOS \
      -DCMAKE_OSX_SYSROOT="$sdk" \
      -DCMAKE_C_COMPILER=$CC \
      -DCMAKE_CXX_COMPILER=$CXX
    printf "#====================== Make build ======================#\n" >> "../$objdir/build.log"
    make -j
    ens
}


_show_log="\
This file contains any messages generated at the time of compilation to help debug when there is a configuration error

which was generated by ios-obj
Invocation command line was

  $ $0 $@

CC="$CC"
CXX="$CXX"

"


mkdir -p "$objdir";
rm -f "$objdir/build.log"
touch "$objdir/build.log"

printf "$_show_log" >> "$objdir/build.log"

main 2>&1 | tee -a "$objdir/build.log"

echo -e "\nreturn: $?" >> "$objdir/build.log"
